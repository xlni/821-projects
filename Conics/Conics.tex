%Document setup
\documentclass[10pt,a4paper]{amsart} 

\usepackage[latin1]{inputenc}
\usepackage{mathtools} 
\usepackage{amssymb} 
\usepackage{mathrsfs} % gives mathscr font 
\usepackage{graphicx}
%\usepackage[headsep=0.15in, left=0.5in, right=0.5in, top=0.6in, bottom=0.5in]{geometry} 
%\usepackage[textlf,mathlf]{MinionPro} 
\usepackage{fancyhdr}
%\usepackage{xypic}
\usepackage{tikz-cd} 
\usepackage{todonotes}
\usepackage{verbatim}
\usepackage{filecontents}
\usepackage[colorlinks=true]{hyperref}
\usepackage{tabu}
\usepackage{multicol}
\usepackage{booktabs}
\usepackage{centernot}

\definecolor{zaffre}{rgb}{0.0, 0.08, 0.66}
\hypersetup{colorlinks=true,allcolors=zaffre}

%Environments
\numberwithin{equation}{section} 
\numberwithin{figure}{section}
\numberwithin{table}{section}
\theoremstyle{definition} 
\theoremstyle{plain} 
\newtheorem{thm}{\protect\theoremname}[section]
\newtheorem{example}[thm]{\protect\examplename}
\theoremstyle{remark} 
\newtheorem*{rem*}{\protect\remarkname}
\theoremstyle{plain}
\newtheorem{cor}[thm]{\protect\corollaryname}
\theoremstyle{definition} 
\newtheorem{defn}[thm]{\protect\definitionname}
\theoremstyle{plain} 
\newtheorem{prop}[thm]{\protect\propositionname}
\theoremstyle{plain} 
\newtheorem{lem}[thm]{\protect\lemmaname}

\providecommand{\definitionname}{Definition}
\providecommand{\examplename}{Example} 
\providecommand{\lemmaname}{Lemma}
\providecommand{\propositionname}{Proposition}
\providecommand{\remarkname}{Remark} 
\providecommand{\corollaryname}{Corollary}
\providecommand{\theoremname}{Theorem}

\setcounter{tocdepth}{1}

%macros, etc.
\newcommand{\legendre}[2]{\genfrac{(}{)}{}{}{#1}{#2}}
\renewcommand{\arraystretch}{1.2} 

\newcommand{\A}{\mathbb{A}}
\renewcommand{\P}{\mathbb{P}} 
\newcommand{\F}{\mathbb{F}}
\newcommand{\Z}{\mathbb{Z}}
\newcommand{\Q}{\mathbb{Q}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\GL}{\operatorname{GL}}
\newcommand{\Span}{\operatorname{Span}}
\newcommand{\trsp}[1]{{{#1}^{\top}\!\!}}
\newcommand{\ndiv}{\centernot|}

\begin{document} 
	
	\title{Solutions to Conics Modulo a Prime and in the Rational Numbers} 
	\author{Xianglong Ni, Oron Propp, and Miguel Young}
	\maketitle
	
	\begin{abstract} 
		We count the number of solutions of any affine plane conic modulo a prime.
		We use this result to determine whether such a conic has rational solutions. 
	\end{abstract}
	
	\tableofcontents
	
	\section{Introduction}\label{sec:intro} 
	
	% Get a reference for general nonsense over the reals
	A \emph{conic section} on the real plane $\R^2$ is the solution set of 
	a polynomial
	\[ C: ax^2 + bxy + cy^2 + dx + ey + f = 0, \]
	where the degree-2 coefficients $a, b, c$ are not all zero. This conic can be \emph{projectivized} by adding an additional
	unknown to make the polynomial homogeneous:
	\[ \widetilde{C}: aX^2 + bXY + cY^2 + dXZ + eXZ + fZ^2 = 0. \]
	This gives a quadratic form on $\R^3$; when this form is degenerate, we
	say that the original conic, $C$, is also degenerate.
	
	The homogeneous part of $C$, $ax^2 + bxy + cy^2$, gives a quadratic form
	on $\R^2$, with matrix
	\[ \begin{bmatrix}
	a & b/2 \\
	b/2 & c
	\end{bmatrix}. \]
	The determinant of this matrix, called the \emph{discriminant} and
	denoted $-4\Delta = b^2 - 4ac$, gives a characterization of the shape of $C$
	when it is nondegenerate. Positive, zero, and negative discriminant
	correspond to $C$ being an ellipse, a parabola, or a hyperbola. The
	projectivized conic also gives rise to a quadratic form; we say $C$ is
	degenerate when the matrix of $\widetilde{C}$ is singular. The curve
	will instead look like a pair of parallel or intersecting lines, a double
	line (where each point of the line is a solution of the conic and its 
	derivative), a single point, or no points at all. 
	
	The above discussion of the \emph{real} points of $C$ is fairly classical,
	and a full classification is well-understood. We can instead ask that solutions
	be in some other field $K$.
	The situation when $K=\Q$ turns out to be quite complicated. It is
	characterized by the Hasse--Minkowski theorem, of which we quote a special
	case (see for instance \cite[\S IV.3, Thm.~8]{serre}):
	\begin{thm}[Hasse--Minkowski]
		A quadratic form $C$ over $\Q$ has a solution if and only if it has solutions
		over all the completions of $\Q$, namely, the reals, $\R$, and the $p$-adic
		numbers, $\Q_p$, for all primes $p$.
	\end{thm}
	The case when $K = \R$ is, as mentioned, classical. To solve over $\Q_p$,
	we can simply ask for solutions in $\Z_p$, the $p$-adic integers. We
	can in turn get these solutions through Hensel's lemma, which allows us
	to lift solutions from the finite field $\F_p$ to $\Z_p$. Our ultimate
	goal is to determine when there exist rational points on a given conic $C$, by lifting
	a characterization of its $\F_p$-points.
	
	This paper is roughly divided into two parts. The first part
	is bootstrapping this process by counting solutions over $\F_p$. To do this,
	we study the projectivization of our chosen conic, discussed in
	\S\ref{sec:projectivization-of-the-problem}. We then diagonalize 
	the projective curve through a procedure described in 
	\S\ref{sec:diagonalizing-quadratic-forms}, reducing to a finite number of cases. We work out these cases
	of diagonalized curves in \S\ref{sec:proj-solutions}, and finally
	drop back down to the affine case in \S\ref{sec:affine-solutions}. Our result
	is a complete characterization of the number of solutions, given by 
	Theorem \ref{thm:main-thm}.
	In the second part, we lift solutions to $\Z_p$ by way of
	Hensel's lemma, and use the Hasse--Minkowski theorem
	to completely characterize existence of rational points. This is the content of \S\ref{sec:rational-soln}; our main result is Theorem~\ref{thm:rational-solutions}.
	
	\subsection*{Acknowledgments} Oron wrote sections \S\ref{sec:diagonalizing-quadratic-forms} and \S\ref{sec:affine-solutions}. Together, Xianglong and Oron worked out much of \S\ref{sec:proj-solutions} and \S\ref{sec:rational-soln}, which were later written up by Xianglong (who also wrote \S\ref{sec:projectivization-of-the-problem}). Miguel ran experimental tests to both motivate and verify our computations, wrote \S\ref{sec:intro}, and helped format, edit, and proofread.
	
	We would like to thank the 18.821 course staff for organizing this project, and Rasmus Johansen in particular for his guidance and suggestions. We are also grateful
	to Ari Nieh and Stuart Thomson for their feedback on a draft of this paper.
	
	
	\section{Preliminaries}\label{sec:projectivization-of-the-problem}
	
	Let us begin by fixing a conic
	\begin{equation}\label{eq:original-conic} 
	C \colon ax^2 + bxy + cy^2 + dx + ey + f = 0 
	\end{equation} 
	with integer coefficients. We require that at least one of 
	$a$, $b$, and $c$ is nonzero, and that $\gcd(a,b,c,d,e,f)=1$.
	Fix a base field $\F_p$ where $p$ is an odd prime. (We defer treatment of the case $p = 2$ to \S\ref{sec:affine-solutions}.)
	\begin{defn}
		Let $\A^n_{\F_p}$ denote $n$-dimensional affine space over $\F_p$. Define 
		$n$-dimensional projective space over $\F_p$ as the quotient
		\[ \P^n_{\F_p} = (\A^{n+1}_{\F_p}\setminus \{0\})/{\sim}, \]
		where we declare that $(x_1,\ldots,x_{n+1}) \sim 
		(\lambda x_1,\ldots,\lambda x_{n+1})$ for $\lambda$ a nonzero scalar. We
		will primarily work with $n = 2$, and suppress the ground field from the 
		notation. We will write $[X:Y:Z]\in \P^2$ to denote the equivalence 
		class of $(X,Y,Z)\in \A^3 \setminus \{0\}$.
	\end{defn}
	
	With this construction in mind, we can \emph{projectivize} our conic
	\eqref{eq:original-conic} from $\A^2$ to $\P^2$, by writing it as a 
	homogenous equation: 
	\begin{equation}\label{eq:projective-conic} 
	\widetilde{C} \colon aX^2 + bXY + cY^2 + dXZ + eYZ + fZ^2 = 0. 
	\end{equation}
	Note that homogeneity ensures it is well-defined to ask when this
	equation has a solution in $\P^2$.
	
	Let $C(\F_p)$ denote the solution set of \eqref{eq:original-conic} in $\A^2$. Our aim
	is to characterize $|C(\F_p)|$ as a function of the coefficients $a,b,c,d,e,f$ and 
	the prime $p$. The solutions of \eqref{eq:projective-conic} define a set
	$\widetilde{C}(\F_p) \subset \P^2$.
	
	There is an evident injection $C(\F_p) \rightarrowtail \widetilde{C}(\F_p)$ sending $(x,y)$ to
	$[x:y:1]$. However, elements of $\widetilde{C}(\F_p)$ of the form $[X:Y:0]$ do not 
	correspond to elements of $C(\F_p)$. 
	These are solutions ``at infinity'' in the projective plane.
	Thankfully, these extraneous solutions are easily characterized: they are the
	solutions to the equation
	\begin{equation}\label{eq:projective-conic-at-infinity} 
	\widetilde{C}_0 \colon aX^2 + bXY + cY^2 = 0
	\end{equation} 
	on the projective line $\P^1$. Call this solution set $\widetilde{C}_0(\F_p)\subset \P^1$.  
	
	\begin{lem}\label{lem:relate-solutions-affine-proj}
		$|\widetilde{C}(\F_p)| = |C(\F_p)| + |\widetilde{C}_0(\F_p)|$.
	\end{lem} 
	\begin{proof}
		A solution $[X:Y:Z]$ of $\widetilde{C}$ corresponds 
		to a solution $(X/Z,Y/Z)$ of $C$ when $Z \neq 0$,
		and to a solution $[X:Y]$ of $\widetilde{C}_0$ 
		when $Z = 0$.  
	\end{proof}
	
	We will also need a bit of number theory, since our characterization
	involves the notion of quadratic residues:
	\begin{defn}
		The nonzero elements $\F_p^\times \subset \F_p$ form an abelian
		group under multiplication, and the squaring map 
		\[ \F^\times_p \xrightarrow{x \mapsto x^2} \F^\times_p \]
		is a homomorphism. We will call the image of this map the
		\emph{quadratic residues mod $p$}, or just the \emph{residues} (where the
		prime $p$ is inferred from context). We will also regard $0\in\F_p$ as a residue.
	\end{defn}
	
	If $p$ divides $x^2 - 1 = (x+1)(x-1)$, we must have $x \equiv \pm 1 \bmod{p}$, so 
	the kernel of the map is $\{\pm 1\}$. Thus each nonzero residue has exactly two 
	square roots. The cokernel of this map is also a group of order two: 
	\begin{equation}\label{eqn:cokersquare}
\F_p^\times / (\F_p^\times)^2 \cong \{\pm 1\}.
\end{equation}
	This gives a convenient characterization of quadratic residues:
	\begin{defn}
		The \emph{Legendre symbol} is the cokernel map    
		\[ \legendre{\cdot}{p}: 
		\F_p^\times \to \F_p^\times / (\F_p^\times)^2 \cong \{\pm 1\}, \]
		where $\legendre{a}{p}$ is $-1$ if $a$ is a nonresidue,
		and $1$ if $a$ is a nonzero residue. This map extends to a multiplication-respecting map
		\[ \F_p \to \{-1,0,1\} \]
		with $\legendre{0}{p}$ defined as $0$.
	\end{defn}
	
	\section{Diagonalization of quadratic forms}
	\label{sec:diagonalizing-quadratic-forms} 
	
	In this section, we aim to simplify the equation defining the projectivized conic $\widetilde{C}$ via coordinate-changes of $\P^2$. In doing so,
	we will make extensive use of \texttt{Magma} \cite{magma}, a computer 
	algebra system. Let
	\begin{equation*}
	A=\begin{bmatrix}
	a&b/2&d/2\\
	b/2&c&e/2\\
	d/2&e/2&f
	\end{bmatrix}, \hspace{1cm}
	v = \begin{bmatrix}
	X\\
	Y\\
	Z
	\end{bmatrix}.
	\end{equation*}
	The quadratic form $\trsp{v} A v$ is precisely the equation for $\widetilde{C}$. In this sense, the matrix $A$ represents $\widetilde{C}$ in the coordinates $[X,Y,Z]$.
	
	Now, any $P\in\GL_3(\F_p)$ gives rise to a change of coordinates $v\mapsto Pv$ in $\A^3$, which descends to an automorphism of $\P^2$. Since
	\begin{equation*}
	\trsp{(Pv)} A(Pv)=\trsp{v}(\trsp{P} AP)v,
	\end{equation*}
	the matrix representing $\widetilde{C}$ is $\trsp{P}AP$ in the new coordinates. This transformation $A \mapsto \trsp{P}A P$ does not change the number of solutions of the corresponding conic, as $P$ is invertible. The following result is well-known (see for instance \cite[Prop.~42:1]{omeara}), and thus we state it without proof:
	\begin{thm}
		\label{thm:diag}
		There exists some $P\in\GL_3(\F_p)$ such that $\trsp{P}AP$ is diagonal.
	\end{thm}
	This significantly simplifies the set of conics which we must consider: a diagonal matrix
	\begin{equation*}
	\begin{bmatrix}
	\lambda_1&0&0\\
	0&\lambda_2&0\\
	0&0&\lambda_3
	\end{bmatrix}
	\end{equation*}
	corresponds to the conic defined by $\lambda_1X^2+\lambda_2Y^2+\lambda_3Z^2=0$ (note that we cannot have $\lambda_1=\lambda_2=\lambda_3=0$ by our initial assumptions). Furthermore, scaling any of the coordinates of $\A^3$ by a constant scales the corresponding coefficient of this diagonal form by a square: for instance, after the change of coordinates $X\mapsto sX$, the coefficient $\lambda_1$ becomes $\lambda_1/s^2$. Thus, by \eqref{eqn:cokersquare}, we may assume that each $\lambda_i$ is either $1$, $0$, or $r$, for a fixed nonresidue $r\in\F_p$. This gives $8$ possibilities for $A$; by further scaling and permuting coordinates in each of these cases, we obtain the following:
	\begin{cor}
		\label{cor:sixcases}
		Fix an element $r\in\F_p$ that is not a square. There exists some $P\in\GL_3(\F_p)$ such that $\trsp{P}AP$ is equal to a (nonzero) scalar multiple of one of the following:
		$$
		\begin{tabu}{cccccc}
		(1)&(2)&(3)&(4)&(5)\\
		\begin{bmatrix}
		1&0&0\\
		0&0&0\\
		0&0&0
		\end{bmatrix}&
		\begin{bmatrix}
		1&0&0\\
		0&1&0\\
		0&0&0
		\end{bmatrix}&
		\begin{bmatrix}
		1&0&0\\
		0&r&0\\
		0&0&0
		\end{bmatrix}&
		\begin{bmatrix}
		1&0&0\\
		0&1&0\\
		0&0&1
		\end{bmatrix}&
		\begin{bmatrix}
		1&0&0\\
		0&1&0\\
		0&0&r
		\end{bmatrix}
		\end{tabu}
		$$
	\end{cor}
	Note that we need not distinguish between (nonzero) scalar multiples of these matrices as the corresponding conics have equivalent solution sets. In the next section, we determine how many solutions each of the corresponding conics has in $\P^2$. For now, we determine to which of these five matrices $A$ corresponds.
	
	\begin{lem}
		\label{thm:diag-P2}
		In the context of Corollary~\ref{cor:sixcases}, let
		\begin{align*}
		\alpha &= 4acf + bde - ae^2 - fb^2 - cd^2,\\
		\beta &= 4ac + 4af + 4cf - b^2 - d^2 - e^2,
		\end{align*}
        and let $\gamma$ be the first nonzero element of the tuple
        \begin{equation*}
        (4ac-b^2,4af-d^2,4cf-e^2).
        \end{equation*}
		The matrix $A$ corresponds via Corollary~\ref{cor:sixcases} to case
		\begin{enumerate}
          \leftskip 12pt
			\item\label{case:1} if $\alpha=\beta=0$;
			\item\label{case:11} if $\alpha=0$, $\beta\ne 0$, 
			and $\gamma$ is a nonzero residue;
			\item\label{case:1r} if $\alpha=0$, $\beta\ne 0$, 
			and $\gamma$ is a nonresidue;
			\item[(4) or (5)]\label{case:rank3} if $\alpha$ is nonzero.
		\end{enumerate}
	\end{lem}
    Note that we do not distinguish between cases (4) and (5) as the corresponding conics will be shown to have the same number of solutions in \S\ref{sec:proj-solutions}.
	\begin{proof}
		Let $P\in\GL_3(\F_p)$ be such that $\trsp{P}AP$ is a (nonzero) scalar multiple of one of the five matrices in Corollary~\ref{cor:sixcases}; since $P$ is invertible, the rank of $\trsp{P}AP$ is equal to that of $A$. By the rank-nullity theorem, the rank of $A$ is given by subtracting from $3$ the multiplicity of the eigenvalue $0$: this multiplicity is the highest power of $t$ dividing the characteristic polynomial of $A$. A \texttt{Magma} computation shows that the characteristic polynomial of $A$ is given by
		\begin{equation*}
		t^3+(-a-c-f)t^2+\tfrac{1}{4}(4ac+4af+4cf-b^2-d^2-e^2)t+\tfrac{1}{4}(-4acf - bde + ae^2 + fb^2 + cd^2).
		\end{equation*}
        The constant coefficient of this polynomial vanishes precisely when $\alpha$ does, and its degree-$1$ coefficient vanishes precisely when $\beta$ does. We now divide into three cases depending the rank of $A$, which corresponds by the preceding discussion to the vanishing of $\alpha$ and $\beta$:

		\textbf{Rank 1.} The rank of $A$ is $1$ when $\alpha=\beta=0$, which gives case \eqref{case:1} of the lemma.
		
		\textbf{Rank 2.} Likewise, the rank of $A$ is $2$ when $\alpha=0$ and $\beta\ne 0$. Since $\beta$ is the sum of $4ac-b^2$, $4af-d^2$, and $4cf-e^2$, these cannot all be zero, which justifies the definition of $\gamma$. Permute the coordinates $X$, $Y$, and $Z$ of $\A^3$ so that $\gamma$ is given by $4ac-b^2$ (for instance, if $\gamma=4af-d^2$, the permutation $[X,Y,Z]\mapsto[X,Z,Y]$ permutes these coefficients appropriately). Note that $\alpha$ and $\beta$ are invariant under such permutations. We proceed by further breaking into four cases depending on the entries of $A$, and explicitly diagonalizing $A$ in each case:

\emph{Case 1: $a\ne 0$.} Here the \texttt{Magma} method \texttt{DiagonalForm()} shows that $A$ diagonalizes via
		\begin{equation*}
		\begin{bmatrix}
		1 & -\dfrac{b}{2a} & \dfrac{be - 2cd}{4ac - b^2}\\
		0 & 1 & \dfrac{-2ae + bd}{4ac - b^2} \\
		0 & 0 & 1
		\end{bmatrix}^\top\!
		A
		\begin{bmatrix}
		1 & -\dfrac{b}{2a} & \dfrac{be - 2cd}{4ac - b^2}\\
		0 & 1 & \dfrac{-2ae + bd}{4ac - b^2} \\
		0 & 0 & 1
		\end{bmatrix}
		=
		\begin{bmatrix}
		a&0&0\\
		0&\dfrac{4ac-b^2}{4a}&0\\
		0&0&0
		\end{bmatrix}.
		\end{equation*}
		Scaling $X\mapsto aX$ and $Y\mapsto Y/2$ shows that this diagonal matrix corresponds via Corollary~\ref{cor:sixcases} to \eqref{case:11} if $\gamma=4ac-b^2$ is a nonzero residue and to \eqref{case:1r} if it is not.

        \emph{Case 2: $a=0$ and $c\ne 0$.} After permuting coordinates via $[X,Y,Z]\mapsto[Y,X,Z]$, the previous case applies with $\gamma$ unchanged.
		
		\emph{Case 3: $a=c=0$ and $f\ne 0$.} Here a similar \texttt{Magma} computation shows that $A$ diagonalizes via
		\begin{equation*}
		\begin{bmatrix}
		0 & 0 & 1\\
		0 & 1 & \dfrac{2bf - de}{e^2}\\
		1 & -\dfrac{e}{2f} & -\dfrac{b}{e}
		\end{bmatrix}^\top\!
		A
		\begin{bmatrix}
		0 & 0 & 1\\
		0 & 1 & \dfrac{2bf - de}{e^2}\\
		1 & -\dfrac{e}{2f} & -\dfrac{b}{e}
		\end{bmatrix}
		=
		\begin{bmatrix}
		f&0&0\\
		0&-\dfrac{e^2}{4f}&0\\
		0&0&0
		\end{bmatrix}.
		\end{equation*}
		Scaling $X\mapsto fX$ and $Y\mapsto(e/2)Y$ shows that this diagonal matrix corresponds via Corollary~\ref{cor:sixcases} to \eqref{case:11} if $-1$ is a nonzero residue and to \eqref{case:1r} if it is not. In this case, the diagonalizing matrix $P$ is only well-defined if $e$ is nonzero as well, but this is clear as the condition $\alpha=0$ is equivalent to $bf=de$, and $b\ne 0$ as $\gamma=4ac-b^2=-b^2\ne 0$. Thus, $\gamma$ is a residue if and only if $-1$ is, which gives the desired result.

\emph{Case 4: $a=c=f=0$.} Here either $d=0$ or $e=0$, and the same \texttt{Magma} computation shows that
		\begin{equation*}
		\begin{bmatrix}
		1 & -1/2 & -e/b\\
		1 & 1/2 & 0\\
		0 & 0 & 1
		\end{bmatrix}^\top\!
		A
		\begin{bmatrix}
		1 & -1/2 & -e/b\\
		1 & 1/2 & 0\\
		0 & 0 & 1
		\end{bmatrix}
		=
		\begin{bmatrix}
		b&0&0\\
		0&-b/4&0\\
		0&0&0
		\end{bmatrix}
\end{equation*}
when $d=0$ and
\begin{equation*}
		\begin{bmatrix}
		1 & -1/2 & 0\\
		1 & 1/2 & -d/b\\
		0 & 0 & 1
		\end{bmatrix}^\top\!
		A
		\begin{bmatrix}
		1 & -1/2 & 0\\
		1 & 1/2 & -d/b\\
		0 & 0 & 1
		\end{bmatrix}
		=
		\begin{bmatrix}
		b&0&0\\
		0&-b/4&0\\
		0&0&0
		\end{bmatrix}.
		\end{equation*}
when $e=0$.
		In either case, scaling $Y\mapsto Y/2$ shows that the diagonal matrix corresponds via Corollary~\ref{cor:sixcases} to \eqref{case:11} if $-1$ is a nonzero residue and to \eqref{case:1r} if it is not. As before, $\gamma$ is a residue if and only if $-1$ is, giving the desired result.

		\textbf{Rank 3.} Lastly, $A$ has rank $3$ when $\alpha$ is nonzero; the final case of the theorem follows.
	\end{proof}
	
	We will also need an analogous result for quadratic forms $ax^2+bxy+cy^2$ in two variables, which follows immediately from the lemma by setting $d=e=f=0$:
	\begin{cor}\label{cor:diag-P1}
		The matrix
\begin{equation*}
\begin{bmatrix}a&b/2\\b/2&c\end{bmatrix}
\end{equation*}
diagonalizes (as in Corollary~\ref{cor:sixcases}, though with $P \in \GL_2(\F_p)$) to a (nonzero) scalar multiple of
		\begin{itemize}
			\item $\left[\begin{smallmatrix}0&0\\0&0\end{smallmatrix}\right]$ if $a=b=c=0$;
			\item $\left[\begin{smallmatrix}1&0\\0&0\end{smallmatrix}\right]$ if $4ac-b^2=0$;
			\item $\left[\begin{smallmatrix}1&0\\0&1\end{smallmatrix}\right]$ if $4ac-b^2$ is a nonzero residue;
			\item $\left[\begin{smallmatrix}1&0\\0&r\end{smallmatrix}\right]$ if $4ac-b^2$ is a nonresidue.
		\end{itemize}
	\end{cor}
	
	\begin{rem*}
		The discussion in this section suggests a definition for a \emph{degenerate} conic over $\F_p$: they should be the conics whose corresponding quadratic form is degenerate, or equivalently, whose corresponding matrix is singular.
	\end{rem*}
	
	\section{Projective solutions modulo $p$}
	\label{sec:proj-solutions}
	
	In order to determine the number of points a conic $C$ has in $\A^2$, it suffices by Lemma \ref{lem:relate-solutions-affine-proj} to count the number of points on $\widetilde{C}\subset \P^2$ and $\widetilde{C}_0\subset \P^1$. In the preceding section, we showed that these projective conics are equivalent to certain representative forms. Now we compute the number of solutions of each.
	
	We will treat $\widetilde{C}_0$ first.
	\begin{prop}[Counting Solutions in $\P^1$]
		\label{prop:counting-P1-solutions}
		Let $r\in \F_p$ be a nonresidue. Then $\widetilde{C}_0$ is equivalent to one of the following over $\F_p$:
		\begin{enumerate}
			\item \label{case:0} $0 = 0$, with $p+1$ solutions.
			\item $X^2 = 0$, with $1$ solution.
			\item \label{case:x^2+y^2=0} $X^2 + Y^2 = 0$, with 
			$1 + \legendre{-1}{p}$ solutions.
			\item $X^2 + rY^2 = 0$, with 
			$1 - \legendre{-1}{p}$ solutions.
		\end{enumerate}
	\end{prop}
	\begin{proof}
		$\widetilde{C}_0$ being equivalent to one of the four cases is just a restatement of Corollary~\ref{cor:diag-P1}.
		
		In the first case, every point in $\P^1$ is a solution, and $|\P^1| = p+1$. In the second case, $[0:1]$ is the only solution.
		
		In the other two cases, a solution must have nonzero $Y$. We can write the equations as
		$(X/Y)^2 = -1$ and $(X/Y)^2 = -r$ respectively. If $-1$ is a residue,
		then $-r$ is not. It follows that $X^2 + Y^2 = 0$ has two solutions and $X^2 +
		rY^2 = 0$ has none. If $-1$ is a nonresidue, the situation is reversed: $X^2 +
		Y^2 = 0$ has no solutions and $X^2 + rY^2 = 0$ has two solutions.
	\end{proof}
	
	Now we do a similar analysis for $\widetilde{C}$.
	
	\begin{prop}[Counting Solutions in $\P^2$]
		\label{prop:counting-P2-solutions}
		Let $r\in \F_p$ be a nonresidue. Then $\widetilde{C}$ is equivalent to one of the following over $\F_p$:
		\begin{enumerate} 
			\item\label{case:rank1_x^2=0} $X^2 = 0$, with $p+1$ solutions.
			\item\label{case:rank2_x^2+y^2=0} $X^2 + Y^2 = 0$, with
			$p(1+\legendre{-1}{p}) + 1$ solutions.
			\item\label{case:rank2_x^2+ry^2=0} $X^2 + rY^2 = 0$, with
			$p(1-\legendre{-1}{p}) + 1$ solutions.
			\item\label{case:rank3_x^2+y^2+z^2=0} $X^2 + Y^2 + Z^2 = 0$, with $p+1$ solutions.
			\item\label{case:rank3_x^2+y^2+rz^2=0} $X^2 + Y^2 + rZ^2 = 0$, with $p+1$ solutions.
		\end{enumerate}
		In particular, if $\widetilde{C}$ is nondegenerate (i.e. has rank 3), it has $p+1$ solutions.
	\end{prop}
	\begin{proof}
		$\widetilde{C}$ being equivalent to one of the five cases is just a restatement of Corollary~\ref{cor:sixcases}. We treat the cases by rank.
		
		\noindent
		\textbf{Rank 1: \eqref{case:rank1_x^2=0}.}
		The equations $X^2 = 0$ and $rX^2 = 0$ each have $|\P^1|=p + 1$ solutions.
		
		\noindent
		\textbf{Rank 2: \eqref{case:rank2_x^2+y^2=0} and \eqref{case:rank2_x^2+ry^2=0}.} 
		If $-1$ is a residue, pick $s\in \F_p$ with $s^2 = -1$. The equation $X^2 + Y^2 = 0$ factors as
		\[
			(X + sY)(X - sY) = 0
		\]
		and thus its solution set is the union of two lines: $\{X + sY = 0\} \cup \{X - sY = 0\}$. Each line has $p+1$ points, and they intersect at the point $[0:0:1]$. Hence there are $2p+1$ solutions to $X^2 + Y^2 = 0$. On the other hand, $-r$ is a nonresidue, so $X^2 + rY^2 = 0$ has only the solution $[0:0:1]$.
		
		If $-1$ is a nonresidue (meaning $-r$ is a residue), the situation is reversed: $X^2 + Y^2 = 0$ has one
		solution while $X^2 + rY^2 = 0$ factors into two lines and has $2p + 1$ solutions.
		
		\noindent
		\textbf{Rank 3: \eqref{case:rank3_x^2+y^2+z^2=0} and \eqref{case:rank3_x^2+y^2+rz^2=0}.} 
		Suppose $-1$ is a residue. If $Z = 0$, then we are in the setting of case \eqref{case:x^2+y^2=0} of
		Proposition \ref{prop:counting-P1-solutions}, which has two
		solutions. Otherwise, we can divide by $Z^2$ and obtain 
		\begin{align*} 
		(X/Z)^2 + (Y/Z)^2 &= -1 \\ 
		(X/Z)^2 + (Y/Z)^2 &= -r 
		\end{align*} 
		respectively. By Proposition \ref{prop:circle-solutions} below, these each have $p - 1$
		solutions. Therefore $X^2 + Y^2 + Z^2 = 0$ and $X^2 + Y^2 + rZ^2 = 0$ each have
		$p+1$ solutions.
		
		Suppose $-1$ is a nonresidue. There are no solutions with $Z=0$, so rewrite the
		equations as above. By Proposition \ref{prop:circle-solutions} again, they each
		have $p + 1$ solutions.
	\end{proof}
	
	\begin{rem*}
		In fact, it is well-known that any nondegenerate conic is isomorphic (as an algebraic variety) to $\P^1$ (see for instance \cite[Prop.~19.3.1]{vakil}). This explains why cases \eqref{case:rank3_x^2+y^2+z^2=0} and \eqref{case:rank3_x^2+y^2+rz^2=0} both have $|\P^1|=p+1$ solutions.
	\end{rem*}
	
	\begin{prop}\label{prop:circle-solutions} 
		For $a \neq 0$, the equation $x^2 + y^2 = a$ has $p - \legendre{-1}{p}$ 
		solutions over $\F_p$.
	\end{prop} 
	\begin{proof} 
		Let $C_a$ denote the (affine) conic $x^2 + y^2 = a$. 
		First we will show the statement for $a=1$.
		
		Let $T$ denote the set of square-roots of $-1$ in $\F_p$. In the case
		that $-1$ is a nonresidue, $T$ is empty. Consider the maps $f\colon C_1(\F_p)
		\setminus (1,0) \to \F_p \setminus T$ and $g\colon \F_p
		\setminus T \to C_1(\F_p) \setminus (1,0)$ defined by 
		\begin{align*} 
		f(x,y) &= \frac{y}{x-1} \\ 
		g(m) &= \left(\frac{m^2 - 1}{m^2 + 1}, \frac{-2m}{m^2 + 1}\right).
		\end{align*} 
		It is easy to check that they are inverse to one
		another, from which it follows that $|C_1(\F_p)| = |\F_p| - |T| + 1 = p -
		\legendre{-1}{p}$ as desired.
		
		Note that if $a,a'$ are both nonzero residues (or both nonresidues)
		then $|C_a(\F_p)| = |C_{a'}(\F_p)|$. From the preceding, we have the claim for all residues
		$a$. Observe that $C_0(\F_p) \cup \cdots \cup C_{p-1}(\F_p)$ gives a partition of
		$\mathbb{A}^2$. Since 
		\[ |C_0(\F_p)| = \begin{cases}
		1 & \text{if } \legendre{-1}{p} = -1 \\
		-1 & \text{if } \legendre{-1}{p} = 1 \\
		\end{cases} \] 
		for a nonresidue $a$ we have 
		\[ |C_a(\F_p)| = \frac{2}{p-1} 
		\left(p^2 - |C_0(\F_p)| - \frac{p-1}{2}|C_1(\F_p)|\right) = 
		p - \legendre{-1}{p}. \qedhere \] 
	\end{proof}
	
	\section{Affine solutions modulo $p$}
	\label{sec:affine-solutions}
	
	We can now use Lemma \ref{lem:relate-solutions-affine-proj} to combine the
	results from the previous two sections into a statement about solutions in $\A^2$. Proposition \ref{prop:counting-P2-solutions} tells us that the projectivized conic $\widetilde{C}$ has $1$, $p+1$, or $2p+1$ solutions in total. Proposition \ref{prop:counting-P1-solutions} says that $0$, $1$, $2$, or $p+1$ of these correspond to points of $\widetilde{C}\cap \{Z = 0\} = \widetilde{C}_0$ and are extraneous, in that they lie ``at infinity'' in the projective plane. These need to be deducted from the total in order to determine the number of solutions in $\A^2$.
	
	However, not all combinations of the above are possible---we cannot have one solution to $\widetilde{C}$ but two solutions to $\widetilde{C}_0$, for example. The following observations eliminate some more cases:
	\begin{enumerate}
		\item\label{case:small-big} Any case where $|\widetilde{C}_0(\F_p)| > |\widetilde{C}(\F_p)|$ is obviously impossible.
		\item\label{case:NA(p+1)-0,2} When $\widetilde{C}$ has rank 1, it is given by an equation of the form $L^2 = 0$, where $L$ is linear in $X,Y,Z$. If $\{L=0\}$ coincides with $\{Z = 0\}$, then $p+1$ solutions are extraneous. Otherwise, $\{L=0\}$ and $\{Z=0\}$ intersect at one point, so there is one extraneous solution.
		\item\label{case:NA(2p+1)-0} When $\widetilde{C}$ has rank 2 and has $2p + 1$ solutions, it
		is given by an equation of the form $L_1 L_2 = 0$ where $L_1,L_2$ are linear in $X,Y,Z$ and are not multiples of each other. The solution set to $\widetilde{C}$ is $\{L_1 = 0\}\cup\{L_2 = 0\}$, and necessarily intersects $\{Z = 0\}$.
		\item\label{case:NA(p+1)-(p+1)} There are $p+1$ solutions in $\{Z = 0\}$ only when the 
		coefficients $a,b,c$ are all zero. This cannot happen when $\widetilde{C}$ has rank 3.
	\end{enumerate}
	These comments are summarized in Table \ref{table:all-possibilities}, which also gives examples over $\F_3$ for all the other combinations, showing that they are actually possible.
	
	\begin{table}[h]
		\begin{tabular}{cccccc}
          \toprule
 \multicolumn{2}{c}{} &
			\multicolumn{4}{c}{$|\widetilde{C}_0(\F_p)|$}  \\\cmidrule(r){3-6}
			rank of $\widetilde{C}$ & $|\widetilde{C}(\F_p)|$ & $0$ & $1$ & $2$ & $p + 1$\\
			\midrule
			$1$ & \multicolumn{1}{c|}{$p+1$} & N/A\textsuperscript{\eqref{case:NA(p+1)-0,2}} & $X^2$ & N/A\textsuperscript{\eqref{case:NA(p+1)-0,2}} & $Z^2$ \\
			$2$ & \multicolumn{1}{c|}{$1$} & $X^2 + Y^2$ & $X^2 + Z^2$ & N/A\textsuperscript{\eqref{case:small-big}} & N/A\textsuperscript{\eqref{case:small-big}} \\
			$2$ &	\multicolumn{1}{c|}{$2p+1$} & N/A\textsuperscript{\eqref{case:NA(2p+1)-0}} & $X^2 + XZ$ & $XY$ & $XZ$ \\
			$3$ & \multicolumn{1}{c|}{$p+1$} & $X^2 + Y^2 + Z^2$ & $XZ+Y^2$ & $X^2 + 2Y^2 + Z^2$ & N/A\textsuperscript{\eqref{case:NA(p+1)-(p+1)}} \\
			\bottomrule
			\multicolumn{2}{c}{}
		\end{tabular}
		\caption{Examples of projective conics $\widetilde{C}$ for the case $p=3$, along with their ranks, number of solutions $|\widetilde{C}(\F_p)|$ in $\P^2$, and number of extraneous solutions $|\widetilde{C}_0(\F_p)|$. The entries marked ``N/A\textsuperscript{($i$)}'' are impossible according to the reasoning in item ($i$) of the above list.}\label{table:all-possibilities}
	\end{table}
	
	Now we give an explicit formula for $|C(\F_p)|$ in terms of the coefficients of $C$ and the prime $p$.
	
	\begin{thm}[Counting Solutions in $\A^2$]
		\label{thm:main-thm}
		Let $C$ be a conic as in (\ref{eq:original-conic}), and fix a prime $p$. We regard the coefficients of $C$ as lying in $\F_p$.
		
		If $p$ is even, then
		\begin{equation*}
		|C(\F_p)| = 2 + b(-1)^{(a + d)(c + e) + f},
		\end{equation*}
		where $b$ is either $0$ or $1$.
		
		If $p$ is odd, let $\alpha$, $\beta$, and $\gamma$ be as defined in 
		Lemma \ref{thm:diag-P2}, and let $\Delta = b^2-4ac$ be the discriminant. 
		If $\alpha$ and $\beta$ are both zero or
		$\alpha$ is nonzero, then:
		\begin{enumerate}
			\item If $a=b=c=0$, then $C(\F_p)$ is empty.
			\item\label{case:Deltazero} Otherwise, if $\Delta = 0$, then $|C(\F_p)| = p$.
			\item\label{case:Deltanonzero} If $\Delta \neq 0$, then
			\[ |C(\F_p)| = p - \legendre{-\Delta}{p}\legendre{-1}{p}. \]
		\end{enumerate}
        In particular, when $C$ is nondegenerate over $\F_p$, either case \eqref{case:Deltazero} or \eqref{case:Deltanonzero} applies depending on $\Delta$, and $C$ has either $p-1$, $p$, or $p+1$ solutions in $\A^2$.

		If instead only $\alpha$ vanishes, then:
		\begin{enumerate}
			\item If $a=b=c=0$, then $|C(\F_p)|=p$.
			\item Otherwise, if $\Delta = 0$, then
			\[ |C(\F_p)| = p\left(1 + \legendre{\gamma}{p}\legendre{-1}{p}\right). \]
			\item If $\Delta \neq 0$, then
			\[ |C(\F_p)| = p\left(1 + \legendre{\gamma}{p}\legendre{-1}{p}\right)
			- \legendre{\gamma}{p}\legendre{-1}{p}. \]
		\end{enumerate}
	\end{thm}
	\begin{proof} 
		The case $p=2$ is very simple and can be checked by hand. There are very few conics over $\F_2$ ($56$, to be exact), and the solutions to 
		\[ ax^2 + bxy + cy^2 + dx + ey + f = 0 \] 
		are the same as the solutions to 
		\[ bxy + (a+d)x + (c+e)y + f = 0.  \] 
		At this point, one can simply list all of the
		possibilities. It can be checked that the number of solutions in each case agrees with the expression in the theorem statement.
		
		The remainder is a synthesis of \S\ref{sec:diagonalizing-quadratic-forms}, 
		\S\ref{sec:proj-solutions}, and Lemma~\ref{lem:relate-solutions-affine-proj}.
	\end{proof}
	
	\begin{comment}
	Consolidate with Example~4.4!
	\textcolor{red}{Note that if we are in case \eqref{case:0} of Proposition~\ref{prop:counting-P1-solutions}, i.e., if $a=b=c=0$, then $\gamma$ is a residue if and only if $-1$ is. Thus, by Theorem~\ref{thm:diag-P2}, we cannot be in cases \eqref{case:rank2_x^2+y^2=0} or \eqref{case:rank2_x^2+ry^2=0} of Proposition~\ref{prop:counting-P2-solutions} where the projectivized conic has only $1$ solution. Were this the case, Lemma~\ref{lem:relate-solutions-affine-proj} would imply that our affine conic has a negative number (to be exact, $-p$) of solutions!}
	\end{comment}
	
	We remark that while the expression for $|C(\F_p)|$ given above appears complicated, it is easily computable. The only parts that may be non-obvious are the Legendre symbols, but with tools such as the law of quadratic reciprocity, these too are readily determined.
	
	\section{Projective rational solutions}
	\label{sec:rational-soln}
	We have shown how to determine the number of solutions to a conic in $\P^2_{\F_p}$. In this section, we will lay out a procedure to do the same in $\P^2_\Q$. Despite being primarily concerned with the rationals, our analysis of solutions over $\F_p$ will still play a role. Moreover, in the course of proving Theorem \ref{thm:rational-solutions}, we obtain criteria for the existence of solutions in the $p$-adics as well.
	
	Given a conic, we may perform a change of basis so that it has the equation
	\[
	aX^2 + bY^2 + cZ^2 = 0
	\]
	where at least one coefficient is nonzero, using the methods of \S\ref{sec:diagonalizing-quadratic-forms}.
	
	Let us first consider the degenerate cases where one or two of the coefficients are zero. If $b=c=0$ then there are infinitely many rational solutions.
	If instead only $c$ is zero, then the conic becomes $aX^2 + bY^2 = 0$. Thus if $-ab$ has a rational square root, the conic has infinitely many rational solutions. Otherwise it has only the solution $[0:0:1]$.
	
	Having addressed the degenerate cases, hereafter we assume that $abc\neq 0$.
	\begin{lem}\label{lem:infinitely-many-Q-soln}
		Suppose $a,b,c$ are nonzero rational numbers and
		\begin{equation}\label{eq:diag-Q-conic}
		aX^2 + bY^2 + cZ^2 = 0
		\end{equation}
		has a solution in $\P^2_\Q$. Then it has infinitely many solutions.
	\end{lem}
	\begin{proof}
		Suppose $[X:Y:Z]\in \P^2_\Q$ is a solution, and assume without loss of generality that $Z\neq 0$. Then if we let $x_0 = X/Z$ and $y_0 = Y/Z$, the point $(x_0,y_0) \in \A^2_\Q$ is a solution to the affine conic
		\[
		ax^2 + by^2 + c = 0.
		\]
		Take $q\in \Q$ with $bq^2 \neq -a$. Consider the line
		\[
		\ell_q\colon y = q(x-x_0) + y_0
		\]
		of slope $q$ passing through $(x_0,y_0)$. Substituting this into the equation for the affine conic gives a quadratic in $x$ with rational coefficients, one of whose solutions is $x_0$ by construction. By Vieta's formulas, the other solution is also rational. Call it $x_q$, and let $y_q = q(x_q - x_0) + y_0$. Hence $(x_q,y_q)$ is also a rational solution to the conic. One can check that only value of $q$ for which $x_0 = x_q$ is $q = -ax_0 / by_0$, as this is when $\ell_q$ is tangent to the conic. Since the family of lines $\{\ell_q\}$ intersect only at $(x_0,y_0)$, it follows that
		\[
		\{(x_q,y_q) \mid q\in\Q,\, bq^2 \neq -a\}
		\]
		is an infinite family of distinct solutions to the affine conic (thus giving an infinite family of solutions to the projective conic \eqref{eq:diag-Q-conic} as well).
	\end{proof}
	This shows that the conic \eqref{eq:diag-Q-conic} has either infinitely many rational solutions, or none at all. The question now reduces to existence. Note that we are able to scale \eqref{eq:diag-Q-conic} by any nonzero constant without altering its solution set, and we are also able to scale individual coefficients by nonzero squares without affecting the existence of solutions. Using these observations, we can assume that $abc$ is square-free, in the sense that $p^2\ndiv abc$ for all $p$.
	
	We make this a bit more precise. Given a prime $p$, a nonzero rational number $q$ can be uniquely expressed as $p^{\nu_p(q)}\frac{m}{n}$ where $\nu_p(q),m,n\in\Z$ and $p\ndiv m,n$. The number $\nu_p(q)$ is the \emph{$p$-adic valuation} of $q$.
	
	Define
	\[
	t_p(a) = \begin{cases}
	1 & \text{if } \nu_p(a)\not\equiv\nu_p(b)\equiv\nu_p(c)\bmod 2,\\
	0 & \text{otherwise,}
	\end{cases}
	\]
	with $t_p(b)$ and $t_p(c)$ defined analogously. Then if we set
	\begin{equation}\label{eq:t_p-squarefree}
	a' = \frac{|a|}{a}\prod_{p \text{ prime}} p^{t_p(a)}
	\end{equation}
	and likewise for $b'$ and $c'$, the conic
	\[
	a'X^2 + b'Y^2 + c'Z^2 = 0
	\]
	is equivalent to our original conic. This new conic has the property that $a',b',c'\in \Z$ and $a'b'c'$ is a nonzero, square-free integer.
	
	Having massaged our conic into this form, the remaining work is taken care of by the following theorem, which is the main result of this section.
	\begin{thm}[Existence of Rational Solutions]\label{thm:rational-solutions}
		Let $a,b,c$ be nonzero integers such that $p^2 \ndiv abc$ for all primes $p$. Then the equation
		\begin{equation}\label{eq:diag-squarefree-conic}
		aX^2 + bY^2 + cZ^2 = 0
		\end{equation}
		has a solution in $\P^2_\Q$ exactly when all of the following conditions are met.
		\begin{enumerate}
			\item\label{cond:real-soln} At least one of $a,b,c$ is positive, and at least one is negative.
			\item\label{cond:Qp-soln} For all primes $p>2$ dividing $c$, $\legendre{-ab}{p} = 1$. The analogous conditions for primes $p>2$ dividing $a$ or $b$ are required as well.
			\item\label{cond:Q2-soln} Over the $2$-adics, the coresponding conic in Table \ref{table:Q2-diag-conics} has a solution. (This condition will be explained below; see also Lemma 
			\ref{lem:squares-in-Q2}.)
		\end{enumerate}
		Moreover, if \eqref{eq:diag-squarefree-conic} has a solution in $\P^2_\Q$, then it has infinitely many solutions.
	\end{thm}
	The last claim is just a restatement of Lemma \ref{lem:infinitely-many-Q-soln}.
	We prove this theorem through a sequence of lemmas. The overall strategy is guided by the Hasse--Minkowski theorem, which states that a homogeneous quadratic has a solution in $\P^n_\Q$ if and only if it has a solution in $\P^n_K$ for every completion $K$ of $\Q$. These completions are the reals $\R$ and the $p$-adics $\Q_p$ for each prime $p$, which we define below.
	
	The case $K=\R$ is easy. A necessary and sufficient condition for a solution 
	to \eqref{eq:diag-squarefree-conic} in $\P^2_\R$ is given by 
	\eqref{cond:real-soln} above.
	
	The remaining completions are the fields of $p$-adic numbers $\Q_p$, whose definition 
	we review now.
	\begin{defn}
		The ring of \emph{$p$-adic integers} $\Z_p$ is the inverse limit of
		\[
		\cdots \to \Z/p^3 \to \Z/p^2 \to \Z/p.
		\]
	\end{defn}
	In other words, elements of $\Z_p$ are sequences $(a_1,a_2,a_3,\ldots)$ where $a_i \in \Z/p^i$ and $a_{i+1} \equiv a_i\bmod {p^i}$.
	
	Such an element can also be interpreted as the series
	\[
	b_0 + b_1 p + b_2 p^2 + b_3 p^3 + \cdots
	\]
	where $b_0 = a_1$ and $b_i = (a_{i+1} - a_i)/p^i$ for $i \geq 1$. Addition and multiplication are done as expected with ``rightwards carrying.''
	
	Since $\Z_p$ is an integral domain, we are justified in taking its fraction field:
	\begin{defn}
		The field of \emph{$p$-adic numbers} $\Q_p$ is the fraction field of $\Z_p$.
	\end{defn}
	Since the units in $\Z_p$ are the elements with $b_0 \neq 0$, constructing $\Q_p$ amounts to inverting $p$ in $\Z_p$. Thus elements of $\Q_p$ can also be interpreted as series, though they are allowed to start from negative powers of $p$.
	
	We refer the reader to \cite[Thm.~6.7]{bilu} for a proof of the following formulation of Hensel's lemma.
	\begin{lem}[Multivariate Hensel's lemma]\label{thm:hensels-one-eq}
		Let $k$ be a nonnegative integer. Let $f \in \Z_p[x_1,\ldots,x_n]$ be a polynomial in $n$ variables and suppose $a = (a_1,\ldots,a_n)\in \Z_p^n$ satisfies $f(a) = 0 \bmod {p^{2k+1}}$ and $\frac{\partial f}{\partial x_i}(a) \not\equiv 0 \bmod {p^{k+1}}$ for some $i\in \{1,\ldots,n\}$. Then there exists $\widetilde{a} \in \Z_p^n$ such that, for all $i$, $\widetilde{a}_i\equiv a_i \bmod {p^{2k+1}}$ and $f(\widetilde{a}) = 0$.
	\end{lem}
	To determine whether \eqref{eq:diag-squarefree-conic} has a solution in $\P^2_{\Q_p}$, we will make extensive use of this result. Note that, because the equation is homogeneous, existence of a solution over $\Q_p$ is the same as existence of a solution over $\Z_p$.
	
	The following two lemmas address existence of solutions in $\Q_p$ for odd $p$.
	\begin{lem}
		With the setup of Theorem \ref{thm:rational-solutions}, if $p > 2$ is a prime that does not divide $abc$, then \eqref{eq:diag-squarefree-conic} has a solution in $\P^2_{\Q_p}$.
	\end{lem}
	\begin{proof}
		We will apply Hensel's lemma with $k=0$. By Proposition \ref{prop:counting-P2-solutions}, \eqref{eq:diag-squarefree-conic} has $p+1$ solutions in $\P^2_{\F_p}$. The condition on partial derivatives is automatically satisfied: for any $[X:Y:Z]\in \P^2$ one of $X,Y,Z$ is nonzero, and thus one of $2aX, 2bY, 2cZ$ is as well. Hence any of the solutions over $\F_p$ can be lifted via Hensel's lemma to a solution over $\Q_p$.
	\end{proof}
	
	Otherwise, if $p\mid abc$, then $p$ divides either $a$, $b$, or $c$. We treat the last case; the other two cases are analogous.
	
	\begin{lem}
		With the setup of Theorem \ref{thm:rational-solutions}, suppose $p > 2$ is a prime dividing $c$. Then \eqref{eq:diag-squarefree-conic} has a solution in $\P^2_{\Q_p}$ if and only if $\legendre{-ab}{p}=1$ (condition \eqref{cond:Qp-soln} of Theorem \ref{thm:rational-solutions}).
	\end{lem}
	\begin{proof}
		When we reduce mod $p$, \eqref{eq:diag-squarefree-conic} becomes
		\begin{equation}\label{eq:p|abc-modp}
		aX^2 + bY^2 \equiv 0 \bmod p
		\end{equation}
		If $\legendre{-ab}{p}=1$, then take $s\in \F_p$ such that $s^2 = -ab$, and $[s:a:0]$ is a solution satisfying the hypotheses of Hensel's lemma with $k=0$. Thus \eqref{eq:diag-squarefree-conic} has a solution over $\Z_p$ in this case.
		
		Suppose instead that $\legendre{-ab}{p}=-1$. For the sake of contradiction, assume a solution $[X:Y:Z]$ existed over $\Q_p$. By scaling as needed, we can assume that $X,Y,Z\in \Z_p$ and not all of them are divisible by $p$. Since $-ab$ is a nonresidue, \eqref{eq:p|abc-modp} entails $X,Y \equiv 0 \bmod p$ (c.f. \S\ref{sec:proj-solutions}). Then we can write
		\[
		ap^2 (X/p)^2 + bp^2 (Y/p)^2 + cZ^2 = 0
		\]
		but we assumed that $p^2\ndiv c$, so this implies $p|Z$ and we have a contradiction.
	\end{proof}
	This leaves only the case $K = \Q_2$ to consider. The situation is more contrived here,
	and it is responsible for the final condition of Theorem 
	\ref{thm:rational-solutions}. We'll need the following characterization of squares
	in $\Q_2$.
	
	\begin{lem}\label{lem:squares-in-Q2}
		Let
		\[
		a = 2^{2m + i}(1 + j\cdot 2 + k \cdot 4+ \cdots)
		\]
		where $m$ is an integer and each of $i,j,k$ is either 0 or 1. Define
		\[
		\bar{a} = 2^i 3^j 5^k.
		\]
		Then $a/\bar{a}$ is a square in $\Q_2$.
	\end{lem}
	\begin{proof}
		We claim that if $s\in \Z_2$ is congruent to $1\bmod 8$, then it is a square. Consider the equation $x^2 - s=0$. Applying Hensel's lemma with $k=1$ to the solution $x = 1$ shows that it can be lifted to a solution in $\Z_2$ as desired.
		By checking each case for $j$ and $k$, one sees that $2^{-2m} a/\bar{a} \equiv 1 \bmod 8$, from which it follows that $a/\bar{a}$ is a square.
	\end{proof}
	\begin{table}[h]
		\begin{tabular}{r@{\hskip 18pt}l}
			\toprule
			Equation & Solution in $\P^2_{\Q_2}$\\
			\midrule
			$X^2 + Y^2 + Z^2 = 0$ & No \\ 
			$2X^2 + Y^2 + Z^2 = 0$ & No \\ 
			$3X^2 + Y^2 + Z^2 = 0$ & Yes, lift $[1:1:2]$ \\ 
			$5X^2 + Y^2 + Z^2 = 0$ & No \\ 
			$6X^2 + Y^2 + Z^2 = 0$ & Yes, lift $[1:1:1]$ \\ 
			$10X^2 + Y^2 + Z^2 = 0$ & No \\ 
			$15X^2 + Y^2 + Z^2 = 0$ & Yes, lift $[1:1:0]$ \\ 
			$30X^2 + Y^2 + Z^2 = 0$ & Yes, lift $[1:1:1]$ \\ 
			$3X^2 + 2Y^2 + Z^2 = 0$ & No \\
			$5X^2 + 2Y^2 + Z^2 = 0$ & Yes, lift $[1:1:1]$ \\ 
			$5X^2 + 3Y^2 + Z^2 = 0$ & Yes, lift $[1:1:0]$ \\ 
			$6X^2 + 5Y^2 + Z^2 = 0$ & No \\ 
			$10X^2 + 3Y^2 + Z^2 = 0$ & No \\ 
			$15X^2 + 2Y^2 + Z^2 = 0$ & Yes, lift $[1:0:1]$ \\ 
			$5X^2 + 3Y^2 + 2Z^2 = 0$ & Yes, lift $[1:1:0]$ \\ 
			\bottomrule
			\multicolumn{2}{c}{}
		\end{tabular}
		
		\caption{An exhaustive list of representative conics over $\Q_2$. Here, ``lift'' means to apply Hensel's lemma with $k=1$ to the specified mod 8 solution.}
		\label{table:Q2-diag-conics}
	\end{table}
	Thus we can scale the coordinates of \eqref{eq:diag-squarefree-conic} over $\Q_2$ so that the coefficients each have the form $2^i 3^j 5^k$ as in the lemma. Then, using \eqref{eq:t_p-squarefree}, we can make their product square-free. The result will be one of the equations listed in Table \ref{table:Q2-diag-conics}. Many of these have solutions mod 8 which can be lifted using Hensel's lemma (where we use $k=1$). The other ones do not, and the claim is that they have no solutions over $\Q_2$.
	
	We prove this claim for the equation $X^2 + Y^2 + Z^2 = 0$ and omit the rest (which are similar). Suppose a solution $[X:Y:Z]$ existed over $\Q_2$. We can assume that $X,Y,Z\in \Z_2$ and that not all of them are divisible by 2. However, 1 is the only odd residue mod 8, from which it is easy to check that $X^2 + Y^2 + Z^2 = 0$ has no such solutions mod 8 (let alone such a solution over $\Z_2$).
	
	With the question of $p=2$ settled, this concludes the proof of Theorem \ref{thm:rational-solutions}. We comment that the powerful machinery of Hilbert symbols can be used to deduce the same result, and we leave this to the curious reader to verify.
	\begin{filecontents}{references.bib}
		@book {omeara,
			AUTHOR = {O'Meara, O. Timothy},
			TITLE = {\href{https://link.springer.com/book/10.1007\%2F978-3-642-62031-7}{Introduction to quadratic forms}},
			SERIES = {Classics in Mathematics},
			NOTE = {Reprint of the 1973 edition},
			PUBLISHER = {Springer-Verlag, Berlin},
			YEAR = {2000},
			PAGES = {xiv+342},
			ISBN = {3-540-66564-1},
			MRCLASS = {11Exx},
			MRNUMBER = {1754311},
		}
		@article{magma,
			author={Wieb Bosma and John Cannon and Catherine Playoust},
			title={\href{http://www.sciencedirect.com/science/article/pii/S074771719690125X}{The Magma algebra system {I}: The user language}},
			journal={Journal of Symbolic Computation},
			volume={24},
			year={1997},
			pages={235--265}
		}
		@misc{bilu,
			author={Yuri Bilu},
			title={\href{https://www.math.u-bordeaux.fr/~abesheno/bilu.pdf}{$p$-adic numbers and Diophantine equations}},
			year={accessed September 29, 2014}
		}
		@misc{henselMO,
			author={Will Sawin},
			title={Answer to \href{https://mathoverflow.net/questions/108687}{\texttt{https://mathoverflow.net/questions/108687}}}
		}
		
		@book{vakil,
			title={\href{http://math.stanford.edu/~vakil/216blog/index.html}{Foundations of Algebraic Geometry}},
			author={Ravi Vakil},
			year={December 29, 2015 version}
		}

@book {serre,
    AUTHOR = {Serre, J.-P.},
     TITLE = {\href{https://link.springer.com/book/10.1007\%2F978-1-4684-9884-4}{A course in arithmetic}},
      NOTE = {Translated from the French,
              Graduate Texts in Mathematics, No. 7},
 PUBLISHER = {Springer-Verlag, New York-Heidelberg},
      YEAR = {1973},
     PAGES = {viii+115},
   MRCLASS = {12-02 (10CXX 10DXX)},
  MRNUMBER = {0344216},
}
	\end{filecontents}
	
	\bibliographystyle{plain}
	\bibliography{references}
	
\end{document}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
